# 기능 명세서: 반복 일정 기능

## 📋 기본 정보

- **Task ID**: task-20251031-000000
- **작성일**: 2025-10-31
- **작성자**: Feature Designer Agent
- **우선순위**: 중간
- **작업 범위 분석**: [task-20251031-000000-scope-analysis.md](./task-20251031-000000-scope-analysis.md)

---

## 🎯 기능 개요

일정 생성 또는 수정 시 반복 유형(매일, 매주, 매월, 매년)을 선택하여 자동으로 여러 일정을 생성하는 기능입니다. 사용자가 반복 간격과 종료일을 설정하면 해당 기간 동안 규칙에 따라 반복되는 일정들이 자동으로 생성됩니다.

---

## 👤 사용자 스토리

**As a** 캘린더 사용자  
**I want** 일정 생성 시 반복 유형을 선택할 수 있다  
**So that** 매주 월요일 회의, 매월 급여일 등 반복되는 일정을 한 번에 등록할 수 있다

### 상세 시나리오

1. **매주 회의 등록**

   - 사용자: "매주 월요일 오전 10시 팀 회의"를 등록하고 싶다
   - 동작: 반복 유형을 "매주"로 선택하고, 종료일을 3개월 후로 설정
   - 결과: 모든 월요일에 팀 회의 일정이 자동으로 생성됨

2. **매월 급여일 알림**

   - 사용자: "매월 25일 급여 확인"을 등록하고 싶다
   - 동작: 반복 유형을 "매월"로 선택하고, 종료일을 1년 후로 설정
   - 결과: 매월 25일에 급여 확인 일정이 생성됨

3. **매년 생일 알림**
   - 사용자: "매년 3월 15일 친구 생일"을 등록하고 싶다
   - 동작: 반복 유형을 "매년"로 선택
   - 결과: 매년 3월 15일에 생일 알림이 생성됨

---

## ✅ 인수 조건 (Acceptance Criteria)

### UI/폼 관련

1. [ ] 일정 생성/수정 폼에 "반복 일정" 체크박스가 표시된다
2. [ ] "반복 일정" 체크박스를 선택하면 반복 설정 UI가 표시된다
3. [ ] 반복 유형 선택 드롭다운에 "매일", "매주", "매월", "매년" 옵션이 있다
4. [ ] 반복 간격을 숫자로 입력할 수 있다 (예: 2를 입력하면 "2일마다", "2주마다" 등)
5. [ ] 반복 종료일을 날짜 선택기로 설정할 수 있다
6. [ ] 반복 종료일은 선택적(optional)이다 (미설정 시 무기한 반복은 제한 적용)

### 반복 일정 생성 로직

7. [ ] 반복 유형이 "매일"인 경우, 설정한 간격(일)마다 일정이 생성된다
8. [ ] 반복 유형이 "매주"인 경우, 설정한 간격(주)마다 같은 요일에 일정이 생성된다
9. [ ] 반복 유형이 "매월"인 경우, 설정한 간격(월)마다 같은 날짜에 일정이 생성된다
10. [ ] 반복 유형이 "매년"인 경우, 설정한 간격(년)마다 같은 날짜에 일정이 생성된다
11. [ ] 반복 종료일이 설정된 경우, 종료일까지만 일정이 생성된다
12. [ ] 반복 종료일이 없는 경우, 기본적으로 2년 또는 최대 100개의 일정으로 제한된다

### 특수 케이스 처리

13. [ ] **31일에 매월 반복을 선택한 경우**: 31일이 존재하는 달에만 일정이 생성된다 (매월 마지막 날이 아님)
    - 예: 1월 31일 → 2월은 건너뜀 → 3월 31일 → 4월은 건너뜀 → 5월 31일
14. [ ] **2월 29일(윤년)에 매년 반복을 선택한 경우**: 윤년의 2월 29일에만 일정이 생성된다
    - 예: 2024년 2월 29일 → 2025년, 2026년, 2027년 건너뜀 → 2028년 2월 29일
15. [ ] **존재하지 않는 날짜는 자동으로 건너뛴다** (에러 없이 다음 유효한 날짜로 이동)

### 일정 겹침 처리

16. [ ] **반복 일정 생성 시 일정 겹침 체크를 수행하지 않는다**
17. [ ] 반복 일정이 기존 일정과 겹치더라도 경고 없이 생성된다
18. [ ] 일반 일정(반복 아님) 생성 시에는 기존처럼 겹침 체크가 동작한다

### API 및 저장

19. [ ] 반복 일정 생성 시 `/api/events-list` 엔드포인트를 사용하여 여러 일정을 한 번에 생성한다
20. [ ] 일반 일정 생성 시에는 기존 `/api/events` 엔드포인트를 사용한다
21. [ ] 생성된 모든 반복 일정은 동일한 `repeatId`를 공유한다 (서버에서 자동 생성)
22. [ ] 반복 일정 생성 완료 후 성공 메시지가 표시된다 (예: "10개의 반복 일정이 생성되었습니다")

### 일정 목록 표시

23. [ ] 생성된 반복 일정들이 캘린더에 정상적으로 표시된다
24. [ ] 각 반복 일정에 반복 정보가 표시된다 (예: "2주마다", "매월")

---

## 🔧 기술적 요구사항

### 관련 컴포넌트/파일

#### 신규 생성

- `src/utils/repeatEventUtils.ts` - 반복 일정 생성 유틸 함수
  - `generateRepeatEvents(baseEvent: EventForm, maxEvents?: number): EventForm[]`
  - `getNextOccurrenceDate(currentDate: Date, baseDate: Date, repeatType: RepeatType, interval: number): Date | null`
  - `isValidRepeatDate(date: Date, baseDate: Date, repeatType: RepeatType): boolean`

#### 수정 필요

- `src/App.tsx` - 반복 일정 UI 활성화 (441-478줄 주석 해제)
- `src/hooks/useEventOperations.ts` - saveEvent 함수 수정

### 필요한 타입 정의

기존 타입 활용 (수정 불필요):

```typescript
// src/types.ts (이미 정의됨)
export type RepeatType = 'none' | 'daily' | 'weekly' | 'monthly' | 'yearly';

export interface RepeatInfo {
  type: RepeatType;
  interval: number;
  endDate?: string;
}
```

### API 엔드포인트

기존 엔드포인트 활용:

- `POST /api/events` - 단일 일정 생성 (기존 로직)
- `POST /api/events-list` - 여러 일정 일괄 생성 (반복 일정용)
  - 요청: `{ events: EventForm[] }`
  - 응답: `Event[]` (생성된 이벤트 배열)

### 핵심 함수 명세

#### 1. `generateRepeatEvents`

```typescript
/**
 * 기준 이벤트로부터 반복 이벤트 배열을 생성합니다.
 *
 * @param baseEvent - 기준 이벤트 (반복 설정 포함)
 * @param maxEvents - 생성할 최대 이벤트 수 (기본값: 100)
 * @returns 생성된 이벤트 폼 배열 (기준 이벤트 포함)
 *
 * 특수 케이스:
 * - 31일 매월: 31일이 없는 달은 건너뜀
 * - 2월 29일 매년: 윤년이 아닌 해는 건너뜀
 * - 종료일 초과: 종료일 이후 일정은 생성 안 함
 */
function generateRepeatEvents(baseEvent: EventForm, maxEvents: number = 100): EventForm[];
```

#### 2. `getNextOccurrenceDate`

```typescript
/**
 * 현재 날짜로부터 다음 반복 발생 날짜를 계산합니다.
 *
 * @param currentDate - 현재 날짜
 * @param baseDate - 기준 날짜 (원본 일정의 날짜)
 * @param repeatType - 반복 유형
 * @param interval - 반복 간격
 * @returns 다음 유효한 날짜 (없으면 null)
 */
function getNextOccurrenceDate(
  currentDate: Date,
  baseDate: Date,
  repeatType: RepeatType,
  interval: number
): Date | null;
```

#### 3. `isValidRepeatDate`

```typescript
/**
 * 특정 날짜가 반복 규칙에 따라 유효한지 검증합니다.
 *
 * @param date - 검증할 날짜
 * @param baseDate - 기준 날짜
 * @param repeatType - 반복 유형
 * @returns 유효 여부
 *
 * 검증 규칙:
 * - 매월 31일: 해당 달에 31일이 존재하는지
 * - 매년 2월 29일: 해당 년도가 윤년인지
 */
function isValidRepeatDate(date: Date, baseDate: Date, repeatType: RepeatType): boolean;
```

---

## 🎨 UI/UX 요구사항

### 레이아웃

1. **반복 설정 UI 위치**

   - 일정 추가 폼의 "카테고리" 선택 아래, "알림 설정" 위에 배치
   - "반복 일정" 체크박스가 먼저 표시됨
   - 체크박스 선택 시 하위 설정 UI가 확장됨

2. **반복 설정 필드 구성**

   ```
   [ ] 반복 일정

   [체크 시 표시됨]
   ┌─────────────────────────────────────┐
   │ 반복 유형:  [매일 ▼]                │
   │                                     │
   │ 반복 간격:  [1] | 반복 종료일: [____]│
   └─────────────────────────────────────┘
   ```

### 인터랙션

1. **반복 일정 체크박스**

   - 체크 해제 시: 반복 설정 UI 숨김, repeat.type = 'none'
   - 체크 시: 반복 설정 UI 표시, 기본값 설정 (매일, 간격 1, 종료일 없음)

2. **반복 유형 선택**

   - Material-UI Select 컴포넌트 사용
   - 옵션: "매일", "매주", "매월", "매년"
   - 선택 시 즉시 상태 업데이트

3. **반복 간격 입력**

   - Material-UI TextField (type="number")
   - 최소값: 1
   - 최대값: 제한 없음 (하지만 99 이상은 비현실적)
   - 유효하지 않은 값 입력 시 에러 표시

4. **반복 종료일 선택**

   - Material-UI TextField (type="date")
   - 선택적 필드 (비워둘 수 있음)
   - 기준 날짜보다 이전 날짜 선택 시 에러 표시

5. **일정 저장 시**
   - 반복 일정인 경우: 로딩 인디케이터 표시 ("반복 일정 생성 중...")
   - 완료 후: 생성된 일정 개수 표시 ("12개의 반복 일정이 생성되었습니다")
   - 특수 케이스로 건너뛴 날짜가 있으면 추가 안내 (선택적)

### 접근성

1. **키보드 네비게이션**

   - 모든 입력 필드 Tab 키로 이동 가능
   - 체크박스는 Space 키로 토글
   - 드롭다운은 Enter 키로 열기, 화살표 키로 선택

2. **스크린 리더 지원**

   - 반복 일정 체크박스에 명확한 레이블
   - 각 입력 필드에 aria-label 또는 연결된 label
   - 에러 메시지는 aria-live로 즉시 읽힘

3. **에러 표시**
   - 유효하지 않은 입력: 빨간색 테두리 + 하단 에러 메시지
   - 툴팁으로 추가 설명 제공

### 예시 UI 스크린샷 설명

```
┌────────────────────────────────────────┐
│ 일정 추가                               │
├────────────────────────────────────────┤
│ 제목: [회의                     ]      │
│ 날짜: [2025-01-31              ]      │
│ ...                                    │
│ 카테고리: [업무 ▼]                     │
│                                        │
│ ☑ 반복 일정                            │
│   ┌──────────────────────────────┐   │
│   │ 반복 유형: [매월 ▼]          │   │
│   │ 반복 간격: [1 ]              │   │
│   │ 반복 종료일: [2025-12-31___] │   │
│   └──────────────────────────────┘   │
│                                        │
│ 알림 설정: [10분 전 ▼]                │
│                                        │
│         [일정 추가]                    │
└────────────────────────────────────────┘
```

---

## ⚠️ 제약사항 및 엣지 케이스

### 제약사항

1. **최대 생성 이벤트 수**

   - 한 번에 최대 100개의 반복 일정 생성 가능
   - 종료일이 없는 경우 기본적으로 2년 또는 100개 중 먼저 도달하는 것 적용

2. **반복 간격 제한**

   - 최소값: 1
   - 권장 최대값: 매일(30), 매주(52), 매월(24), 매년(10)
   - 이를 초과하는 값도 입력 가능하지만 경고 표시

3. **날짜 범위**

   - 과거 날짜에 대한 반복 일정 생성 가능
   - 100년 이상 미래의 일정은 생성하지 않음

4. **반복 종료일**
   - 기준 날짜와 같거나 이후여야 함
   - 기준 날짜보다 이전이면 에러 표시

### 엣지 케이스

#### 1. 31일에 매월 반복 선택

```
시나리오: 사용자가 1월 31일에 "매월 반복" 선택, 종료일 12월 31일
예상 동작:
- 1월 31일 ✅
- 2월 31일 ❌ (존재하지 않음, 건너뜀)
- 3월 31일 ✅
- 4월 31일 ❌ (존재하지 않음, 건너뜀)
- 5월 31일 ✅
- ... (31일이 있는 달만 생성)
- 12월 31일 ✅

결과: 7개의 일정 생성 (1, 3, 5, 7, 8, 10, 12월)
```

#### 2. 윤년 2월 29일에 매년 반복 선택

```
시나리오: 사용자가 2024년 2월 29일에 "매년 반복" 선택
예상 동작:
- 2024년 2월 29일 ✅ (윤년)
- 2025년 2월 29일 ❌ (윤년 아님, 건너뜀)
- 2026년 2월 29일 ❌ (윤년 아님, 건너뜀)
- 2027년 2월 29일 ❌ (윤년 아님, 건너뜀)
- 2028년 2월 29일 ✅ (윤년)

결과: 4년마다 한 번씩만 생성
```

#### 3. 반복 간격이 큰 경우

```
시나리오: 매일 반복, 간격 365일, 종료일 5년 후
예상 동작:
- 1년마다 한 번씩 일정 생성 (사실상 매년 반복과 동일)
- 총 6개의 일정 생성

처리: 정상 동작, 에러 없음
```

#### 4. 종료일이 기준일과 동일

```
시나리오: 2025년 1월 1일, 매일 반복, 종료일도 2025년 1월 1일
예상 동작:
- 1개의 일정만 생성 (기준일 당일)

처리: 정상 동작, 에러 없음
```

#### 5. 반복 일정이 많이 생성되는 경우

```
시나리오: 매일 반복, 종료일 1년 후 (365개 생성 예상)
예상 동작:
- 최대 100개 제한으로 인해 100개만 생성
- 사용자에게 경고 메시지: "반복 일정이 너무 많아 100개까지만 생성되었습니다. 종료일을 조정해주세요."

처리: 100개 생성 후 중단, 경고 표시
```

#### 6. 반복 일정 생성 중 네트워크 오류

```
시나리오: 반복 일정 저장 중 API 호출 실패
예상 동작:
- 에러 메시지 표시: "반복 일정 생성에 실패했습니다. 다시 시도해주세요."
- 부분 생성 없음 (all or nothing)

처리: try-catch로 에러 처리, 롤백
```

#### 7. 반복 일정 수정

```
시나리오: 이미 생성된 반복 일정 중 하나를 수정
예상 동작:
- 해당 일정만 수정됨
- 다른 반복 일정에는 영향 없음
- (향후 개선: "이 일정만" vs "모든 반복 일정" 옵션 추가 가능)

현재 범위: 개별 일정 수정만 지원
```

#### 8. 반복 일정 삭제

```
시나리오: 이미 생성된 반복 일정 중 하나를 삭제
예상 동작:
- 해당 일정만 삭제됨
- 다른 반복 일정에는 영향 없음
- (향후 개선: "이 일정만" vs "모든 반복 일정" 옵션 추가 가능)

현재 범위: 개별 일정 삭제만 지원
```

---

## 📦 의존성

### 선행 작업

- 없음 (기존 기능 확장)

### 영향받는 영역

1. **일정 생성 프로세스**

   - 단일 일정 생성 로직은 유지
   - 반복 일정 생성 로직 추가
   - API 호출 분기 처리

2. **일정 표시**

   - 기존 캘린더 뷰에 반복 일정도 동일하게 표시
   - 반복 정보 표시 추가 (일정 상세 정보)

3. **테스트**
   - 새로운 유틸 함수 단위 테스트 필요
   - 기존 통합 테스트 업데이트 필요

### 영향받지 않는 영역

- 일정 검색 기능
- 일정 알림 기능
- 캘린더 뷰 전환 (주간/월간)
- 공휴일 표시
- 일정 필터링 (카테고리)

---

## 📝 추가 노트

### 구현 우선순위

1. **Phase 1 (필수)**: 기본 반복 생성

   - 매일/매주/매월/매년 반복 로직
   - UI 활성화
   - API 통합

2. **Phase 2 (필수)**: 특수 케이스 처리

   - 31일 매월 반복
   - 2월 29일 매년 반복
   - 유효하지 않은 날짜 건너뛰기

3. **Phase 3 (권장)**: 사용자 경험 개선

   - 생성될 일정 개수 미리 표시
   - 건너뛴 날짜 알림
   - 최대 개수 제한 경고

4. **Phase 4 (선택)**: 향후 개선
   - 반복 일정 일괄 수정/삭제
   - 더 복잡한 반복 규칙 (예: 매월 첫째 주 월요일)
   - 반복 일정 시각적 그룹화

### 기술적 참고사항

1. **날짜 계산**

   - JavaScript Date 객체의 `setMonth()`, `setDate()` 활용
   - 존재하지 않는 날짜 설정 시 자동 조정되는 동작 주의
   - 타임존 이슈 없음 (날짜만 사용)

2. **성능**

   - 100개 이벤트 생성 시에도 빠름 (클라이언트 계산)
   - API 호출은 한 번만 (배치 생성)
   - UI 블로킹 없음 (비동기 처리)

3. **테스트 전략**
   - 날짜 계산 로직: 단위 테스트로 충분히 커버
   - 특수 케이스: 각 케이스별 테스트 케이스 작성
   - 통합 테스트: 전체 플로우 검증

### 알려진 제한사항

1. **반복 일정 그룹 관리 없음**

   - 현재: 각 반복 일정이 독립적인 개별 일정
   - 향후: repeatId로 그룹화하여 일괄 관리 가능

2. **복잡한 반복 규칙 미지원**

   - 현재: 단순 간격 기반 반복만 지원
   - 미지원 예시: "매월 첫째 주 월요일", "평일만"

3. **과거 일정 처리**
   - 과거 날짜에도 반복 일정 생성 가능
   - 실용적이지 않을 수 있으나 제한하지 않음

---

## ✔️ 검토 체크리스트

- [ ] 사용자 스토리가 명확한가?
- [ ] 인수 조건이 측정 가능한가?
- [ ] 엣지 케이스를 충분히 고려했는가?
- [ ] 기존 코드와의 충돌은 없는가?
- [ ] 접근성 요구사항을 포함했는가?
- [ ] 구체적인 입력값과 결과값 예시가 포함되었는가?
- [ ] 문서가 계층화되어 읽기 쉬운가?
- [ ] 새로운 기능이 임의로 추가되지 않았는가?
- [ ] 작업 범위 분석 문서가 작성되었는가?
- [ ] 특수 케이스 (31일 매월, 2월 29일 매년)가 명확히 정의되었는가?
- [ ] 반복일정 겹침 체크 제외 요구사항이 반영되었는가?
- [ ] API 엔드포인트와 데이터 구조가 명시되었는가?
- [ ] 함수 명세가 구체적으로 작성되었는가?

---

## 📌 중요 요구사항 요약

### 1. 특수 날짜 처리 (매우 중요!)

- **31일 매월 반복**: 31일이 **존재하는 달에만** 생성
  - ❌ 매월 마지막 날이 아님
  - ✅ 1, 3, 5, 7, 8, 10, 12월에만 생성
- **2월 29일 매년 반복**: **윤년의 2월 29일에만** 생성
  - ❌ 매년 2월 28일 또는 3월 1일이 아님
  - ✅ 4년(또는 400년 규칙)마다만 생성

### 2. 반복일정 겹침 체크 제외

- 반복 일정은 기존 일정과 겹치더라도 무조건 생성
- 일반 일정은 기존처럼 겹침 체크 수행

### 3. 최대 생성 제한

- 한 번에 최대 100개 또는 2년 중 먼저 도달하는 것
- 초과 시 사용자에게 알림

---

**문서 버전**: 1.0  
**최종 업데이트**: 2025-10-31

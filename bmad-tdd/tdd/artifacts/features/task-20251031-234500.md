# 기능 명세서: 반복 일정 수정

## 📋 기본 정보

- **Task ID**: task-20251031-234500
- **작성일**: 2025-10-31
- **작성자**: Feature Designer Agent
- **우선순위**: 중간

---

## 🎯 기능 개요

사용자가 반복 일정을 수정할 때, "해당 일정만 수정" 또는 "전체 반복 일정 수정" 중 선택할 수 있도록 하는 기능입니다. 단일 수정을 선택하면 해당 일정이 단일 일정으로 변경되며 반복일정 아이콘이 사라지고, 전체 수정을 선택하면 반복 일정 정보가 유지됩니다.

---

## 👤 사용자 스토리

**As a** 캘린더 사용자  
**I want** 반복 일정을 수정할 때 "해당 일정만" 또는 "모든 반복 일정"을 선택하고 싶다  
**So that** 특정 날짜의 일정만 변경하거나 전체 반복 일정을 일괄 변경할 수 있다

### 시나리오 예시

**시나리오 1: 특정 날짜만 수정**

- 매주 월요일 반복되는 "팀 회의" 일정이 있음
- 이번 주 월요일만 시간을 변경하고 싶음
- '예' 선택 → 이번 주 월요일 회의만 시간 변경되고, 단일 일정으로 전환됨
- 다음 주 월요일 회의는 기존 시간 유지

**시나리오 2: 전체 반복 일정 수정**

- 매주 화요일 반복되는 "요가 수업" 일정이 있음
- 앞으로 모든 요가 수업 시간을 변경하고 싶음
- '아니오' 선택 → 모든 반복 일정이 새로운 시간으로 변경됨

---

## ✅ 인수 조건 (Acceptance Criteria)

### 1. 반복 일정 수정 시 다이얼로그 표시

1. [ ] 사용자가 반복 일정(`repeat.type !== 'none'`)을 수정하고 저장 버튼을 클릭하면 확인 다이얼로그가 표시된다
2. [ ] 다이얼로그 제목: "반복 일정 수정"
3. [ ] 다이얼로그 내용: "해당 일정만 수정하시겠어요?"
4. [ ] 다이얼로그 버튼:
   - "예" 버튼: 해당 일정만 수정
   - "아니오" 버튼: 전체 반복 일정 수정
   - "취소" 버튼: 수정 취소
5. [ ] 단일 일정(`repeat.type === 'none'`) 수정 시에는 다이얼로그가 표시되지 않고 바로 수정된다

### 2. "예" 선택 시 동작 (단일 수정)

6. [ ] 해당 일정만 수정된다
7. [ ] 일정의 `repeat.type`이 'none'으로 변경된다
8. [ ] 일정의 `repeat.interval`이 1로 변경된다
9. [ ] 일정의 `repeat.endDate`가 undefined로 변경된다
10. [ ] 반복일정 아이콘이 사라진다 (자동: `RepeatEventIcon`이 `repeat.type === 'none'`이면 null 반환)
11. [ ] "일정이 수정되었습니다." 성공 메시지가 표시된다
12. [ ] 일정 목록이 새로고침된다

### 3. "아니오" 선택 시 동작 (전체 수정)

13. [ ] 해당 일정이 수정된다
14. [ ] 일정의 반복 정보(`repeat`)가 그대로 유지된다
15. [ ] 반복일정 아이콘이 유지된다
16. [ ] "일정이 수정되었습니다." 성공 메시지가 표시된다
17. [ ] 일정 목록이 새로고침된다

### 4. "취소" 선택 시 동작

18. [ ] 다이얼로그가 닫힌다
19. [ ] 수정이 취소되고 폼은 그대로 유지된다
20. [ ] 어떠한 변경도 저장되지 않는다

### 5. 에러 처리

21. [ ] 수정 API 요청 실패 시 "일정 저장 실패" 에러 메시지가 표시된다
22. [ ] 에러 발생 시 다이얼로그가 닫히고 폼은 유지된다

---

## 🔧 기술적 요구사항

### 관련 컴포넌트/파일

- `src/App.tsx` - 반복 일정 수정 확인 다이얼로그 추가
- `src/hooks/useEventOperations.ts` - `saveEvent` 또는 `updateEvent` 로직 수정
- `src/types.ts` - 기존 타입 활용 (수정 불필요)
- `src/components/RepeatEventIcon.tsx` - 기존 컴포넌트 활용 (수정 불필요)

### 필요한 상태 추가 (`src/App.tsx`)

```typescript
const [isRepeatEditDialogOpen, setIsRepeatEditDialogOpen] = useState(false);
const [pendingEventData, setPendingEventData] = useState<Event | null>(null);
```

### 필요한 함수 수정 (`src/App.tsx`)

```typescript
const addOrUpdateEvent = async () => {
  // ... 기존 검증 로직 ...

  const eventData: Event | EventForm = {
    // ... 기존 데이터 구성 ...
  };

  // 반복 일정 수정인 경우 다이얼로그 표시
  if (editingEvent && editingEvent.repeat.type !== 'none') {
    setPendingEventData(eventData);
    setIsRepeatEditDialogOpen(true);
    return;
  }

  // 일반 수정/생성
  const overlapping = findOverlappingEvents(eventData, events);
  if (overlapping.length > 0) {
    setOverlappingEvents(overlapping);
    setIsOverlapDialogOpen(true);
  } else {
    await saveEvent(eventData);
    resetForm();
  }
};
```

### 필요한 함수 추가 (`src/App.tsx`)

```typescript
// 단일 수정 처리
const handleSingleEdit = async () => {
  if (!pendingEventData) return;

  const singleEventData = {
    ...pendingEventData,
    repeat: {
      type: 'none' as RepeatType,
      interval: 1,
      endDate: undefined,
    },
  };

  setIsRepeatEditDialogOpen(false);
  await saveEvent(singleEventData);
  resetForm();
  setPendingEventData(null);
};

// 전체 수정 처리
const handleAllEdit = async () => {
  if (!pendingEventData) return;

  setIsRepeatEditDialogOpen(false);
  await saveEvent(pendingEventData);
  resetForm();
  setPendingEventData(null);
};

// 취소 처리
const handleCancelEdit = () => {
  setIsRepeatEditDialogOpen(false);
  setPendingEventData(null);
};
```

### 다이얼로그 컴포넌트 추가 (`src/App.tsx`)

```typescript
<Dialog open={isRepeatEditDialogOpen} onClose={handleCancelEdit}>
  <DialogTitle>반복 일정 수정</DialogTitle>
  <DialogContent>
    <DialogContentText>해당 일정만 수정하시겠어요?</DialogContentText>
  </DialogContent>
  <DialogActions>
    <Button onClick={handleCancelEdit}>취소</Button>
    <Button onClick={handleSingleEdit} color="primary">
      예
    </Button>
    <Button onClick={handleAllEdit} color="primary">
      아니오
    </Button>
  </DialogActions>
</Dialog>
```

### API 엔드포인트

- 기존 API 활용: `PUT /api/events/:id`
- 요청 body: 수정된 `Event` 객체
- 응답: 수정된 이벤트 정보

---

## 🎨 UI/UX 요구사항

### 레이아웃

- **다이얼로그 위치**: 화면 중앙
- **다이얼로그 크기**: 기존 겹침 경고 다이얼로그와 동일한 스타일
- **버튼 배치**: 오른쪽 정렬 (취소, 예, 아니오 순서)

### 인터랙션

- **다이얼로그 표시 타이밍**: 반복 일정 수정 시 저장 버튼 클릭 직후
- **다이얼로그 닫기**:
  - ESC 키 또는 배경 클릭 시 취소 동작
  - 버튼 클릭 시 해당 동작 실행 후 닫힌다
- **버튼 호버 효과**: Material-UI 기본 스타일 활용
- **포커스 관리**: 다이얼로그 열릴 때 "예" 버튼에 포커스

### 접근성

- **키보드 네비게이션**: Tab 키로 버튼 간 이동 가능
- **스크린 리더**:
  - 다이얼로그 제목 및 내용 읽기
  - 버튼 역할 명확히 전달
- **ARIA 속성**: Material-UI Dialog 기본 ARIA 속성 활용

### 메시지

- **다이얼로그 제목**: "반복 일정 수정"
- **다이얼로그 내용**: "해당 일정만 수정하시겠어요?"
- **버튼 레이블**:
  - "취소": 수정 취소
  - "예": 해당 일정만 수정 (단일 일정으로 변경)
  - "아니오": 전체 반복 일정 수정
- **성공 메시지**: "일정이 수정되었습니다." (기존과 동일)
- **에러 메시지**: "일정 저장 실패" (기존과 동일)

---

## ⚠️ 제약사항 및 엣지 케이스

### 제약사항

1. **반복 일정 판별**: `event.repeat.type !== 'none'`으로 판별
2. **단일 일정 변환**: `repeat.type`을 'none'으로 변경하면 단일 일정으로 전환
3. **기존 패턴 준수**: Material-UI Dialog 컴포넌트 사용
4. **일관된 메시지**: 기존 성공/실패 메시지 형식 유지

### 엣지 케이스

#### 1. 반복 일정을 수정하려는데 겹침 경고도 발생하는 경우

**예상 동작**:

- 반복 일정 수정 다이얼로그를 먼저 표시
- 사용자가 "예" 또는 "아니오" 선택
- 겹침이 있으면 그 다음 겹침 경고 다이얼로그 표시
- 최종적으로 사용자가 "계속 진행" 선택 시 저장

**구현 방법**:

```typescript
const handleSingleEdit = async () => {
  const singleEventData = { ... };
  setIsRepeatEditDialogOpen(false);

  // 겹침 확인
  const overlapping = findOverlappingEvents(singleEventData, events);
  if (overlapping.length > 0) {
    setOverlappingEvents(overlapping);
    setIsOverlapDialogOpen(true);
    setPendingEventData(singleEventData); // 겹침 다이얼로그에서 사용
  } else {
    await saveEvent(singleEventData);
    resetForm();
  }
};
```

#### 2. 사용자가 반복 일정을 단일 일정처럼 보이게 수정하는 경우

**예시**:

- 원본: 매일 반복 (`repeat.type: 'daily'`)
- 수정: 사용자가 반복 체크박스를 해제 (`isRepeating: false`)

**예상 동작**:

- 이 경우 `isRepeating`이 false이므로 `repeat.type`이 'none'으로 설정됨
- 다이얼로그를 표시하지 않음 (이미 단일 일정으로 변경하려는 의도)
- 바로 저장됨

**판별 로직**:

```typescript
// 다이얼로그 표시 조건: 원본이 반복 일정이고, 수정 후에도 반복 일정인 경우
if (editingEvent && editingEvent.repeat.type !== 'none' && isRepeating) {
  // 수정 후에도 반복 설정이 켜져있는 경우
  // 다이얼로그 표시
}
```

**개선된 조건**:

```typescript
// 원본이 반복 일정인 경우만 다이얼로그 표시
if (editingEvent && editingEvent.repeat.type !== 'none') {
  // 사용자가 반복 체크박스를 해제했다면 단일 수정 의도로 간주
  // 다이얼로그 표시
}
```

#### 3. 다이얼로그에서 "취소"를 누른 후 다시 저장 버튼을 클릭하는 경우

**예상 동작**:

- 다이얼로그가 다시 표시됨
- 폼 데이터는 그대로 유지됨
- 사용자가 다시 선택할 수 있음

#### 4. 수정 중 네트워크 오류 발생

**예상 동작**:

- "일정 저장 실패" 에러 메시지 표시
- 다이얼로그 닫힘
- 폼은 유지되어 사용자가 다시 시도할 수 있음

#### 5. 원본이 반복 일정이지만 이미 단일 일정으로 저장된 경우

**시나리오**:

- 사용자가 반복 일정을 생성했으나 서버에서 단일 일정으로 저장됨 (버그 상황)

**예상 동작**:

- `editingEvent.repeat.type`을 기준으로 판단
- 서버 데이터가 단일 일정이면 다이얼로그 표시하지 않음

---

## 📦 의존성

### 선행 작업

- 없음 (기존 반복 일정 기능이 이미 구현되어 있음)

### 영향받는 영역

1. **일정 수정 기능** (직접 영향)

   - 반복 일정 수정 시 다이얼로그 추가
   - 단일/전체 수정 로직 분기

2. **반복일정 아이콘 표시** (간접 영향)

   - 단일 수정 시 아이콘 자동 숨김 (`RepeatEventIcon` 기존 로직 활용)

3. **일정 목록** (간접 영향)
   - 수정 후 목록 새로고침 (기존 로직 활용)

---

## 📝 추가 노트

### 구현 우선순위

1. **높음**: 다이얼로그 표시 및 기본 동작
2. **중간**: 겹침 경고와의 연동
3. **낮음**: 에러 처리 및 엣지 케이스

### 테스트 우선순위

1. **단위 테스트**:

   - 단일 수정 시 `repeat.type`이 'none'으로 변경되는지 확인
   - 전체 수정 시 `repeat` 정보가 유지되는지 확인

2. **통합 테스트**:

   - 반복 일정 수정 시 다이얼로그 표시
   - "예" 선택 시 단일 일정으로 변경
   - "아니오" 선택 시 반복 정보 유지
   - "취소" 선택 시 아무것도 변경되지 않음

3. **UI 테스트**:
   - 다이얼로그 렌더링
   - 버튼 클릭 동작
   - 아이콘 표시/숨김

### 성능 고려사항

- 다이얼로그 표시로 인한 렌더링 비용은 미미함
- API 요청은 기존과 동일 (1회)
- 상태 업데이트 최소화 (필요한 경우만)

### 향후 확장 가능성

- "이번 일정과 이후 모든 일정" 옵션 추가
- "특정 날짜까지만 수정" 옵션 추가
- 반복 일정 수정 이력 관리

---

## ✔️ 검토 체크리스트

- [x] 사용자 스토리가 명확한가?
- [x] 인수 조건이 측정 가능한가?
- [x] 엣지 케이스를 충분히 고려했는가?
- [x] 기존 코드와의 충돌은 없는가?
- [x] 접근성 요구사항을 포함했는가?
- [x] 구체적인 입력값과 결과값 예시가 포함되었는가?
- [x] 문서가 계층화되어 읽기 쉬운가?
- [x] 새로운 기능이 임의로 추가되지 않았는가?
- [x] 작업 범위 분석 문서가 작성되었는가?

---

**작성 완료**: 2025-10-31  
**다음 단계**: 테스트 명세서 작성 (@test-designer)
